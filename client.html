<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ultra Tag Battle</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
  html,body { height:100%; margin:0; font-family: 'Roboto', sans-serif; }
  body { background: linear-gradient(135deg,#1e3c72,#2a5298); display:flex; justify-content:center; align-items:flex-start; }

  .container { background:#fff; padding:30px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.4); width:360px; margin:40px auto; text-align:center; }
  h1 { margin:0 0 12px 0; color:#00ff00; text-transform:uppercase; letter-spacing:2px; text-shadow:0 0 8px #0f0; }
  input { width:100%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid #ccc; }
  button { width:100%; padding:12px; margin:8px 0; background:#00ff00; border:none; border-radius:8px; font-weight:700; cursor:pointer; }
  .toggle-btn { background:none; border:none; color:#2a5298; cursor:pointer; font-size:14px; }

  #homepage { display:none; width:700px; max-width:calc(100vw - 40px); padding:40px; box-sizing:border-box; position:relative; }
  .logout-btn { position:absolute; top:18px; right:18px; background:red; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
  #play-btn { width:320px; height:96px; font-size:28px; border-radius:16px; display:block; margin:48px auto; }
  #online-players { text-align:left; background:#f4f4f4; padding:12px; border-radius:8px; max-height:200px; overflow:auto; }

  .small-card { display:none; width:360px; background:#fff; padding:20px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.4); margin:20px auto; text-align:center; }

  #game-root { display:none; position:fixed; inset:0; width:100%; height:100%; background:#000; }
  #crosshair { position:fixed; left:50%; top:50%; width:14px; height:14px; margin-left:-7px; margin-top:-7px; pointer-events:none; }
  #crosshair:before, #crosshair:after { content:''; position:absolute; left:50%; top:50%; background:#fff; transform:translate(-50%,-50%); }
  #crosshair:before { width:2px; height:14px; }
  #crosshair:after { width:14px; height:2px; }
  .hint { font-size:13px; color:#666; margin-top:8px; }
</style>
</head>
<body>

<!-- Auth container -->
<div class="container" id="auth-container">
  <h1>Ultra Tag Battle</h1>
  <div id="message" style="min-height:20px"></div>
  <input id="email" type="email" placeholder="Email" />
  <input id="password" type="password" placeholder="Password" />
  <button id="signup-btn">Sign Up</button>
  <button id="login-btn">Log In</button>
  <button class="toggle-btn" id="show-lobby-btn">Go to Lobby (if logged in)</button>
  <p class="hint">First login requires a username (permanent).</p>
</div>

<!-- Username setup -->
<div class="small-card" id="username-card">
  <h3>Create your username</h3>
  <input id="username-field" placeholder="Choose a username" />
  <button id="save-username">Save Username</button>
  <div id="username-feedback" style="min-height:18px"></div>
</div>

<!-- Lobby -->
<div id="homepage" class="container">
  <button class="logout-btn" id="logout-btn">Log Out</button>
  <h1>Ultra Tag Battle</h1>
  <button id="play-btn">Play Now</button>
  <h3 style="margin-top:24px;">Online Players</h3>
  <div id="online-players"><em>Loading...</em></div>
</div>

<!-- Game -->
<div id="game-root">
  <div id="crosshair"></div>
  <button class="logout-btn" id="exit-game-btn" style="right:18px; top:18px;">Exit Game</button>
</div>

<script type="module">
/* Firebase setup */
const firebaseConfig = { /* your config */ };
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* Three.js */
import * as THREE from 'https://unpkg.com/three@0.150.1/build/three.module.js';
import { PointerLockControls } from 'https://unpkg.com/three@0.150.1/examples/jsm/controls/PointerLockControls.js';

const authContainer=document.getElementById('auth-container');
const signupBtn=document.getElementById('signup-btn');
const loginBtn=document.getElementById('login-btn');
const messageDiv=document.getElementById('message');
const showLobbyBtn=document.getElementById('show-lobby-btn');
const usernameCard=document.getElementById('username-card');
const usernameField=document.getElementById('username-field');
const saveUsernameBtn=document.getElementById('save-username');
const usernameFeedback=document.getElementById('username-feedback');
const homepage=document.getElementById('homepage');
const playBtn=document.getElementById('play-btn');
const onlinePlayersDiv=document.getElementById('online-players');
const logoutBtn=document.getElementById('logout-btn');
const gameRoot=document.getElementById('game-root');
const exitGameBtn=document.getElementById('exit-game-btn');

function showMsg(str,isError=false){ messageDiv.textContent=str; messageDiv.style.color=isError?'crimson':'#00aa00'; }

/* Sign up / log in */
signupBtn.onclick=async()=>{
  try{await auth.createUserWithEmailAndPassword(email.value,password.value);showMsg('Account createdâ€”please log in.');}
  catch(e){showMsg(e.message,true);}
};
loginBtn.onclick=async()=>{
  try{await auth.signInWithEmailAndPassword(email.value,password.value);showMsg('Logged in.');showLobby();}
  catch(e){showMsg(e.message,true);}
};
showLobbyBtn.onclick=showLobby;

/* Save username */
saveUsernameBtn.onclick=async()=>{
  const val=usernameField.value.trim();
  if(!val||!/^[A-Za-z0-9_]{3,20}$/.test(val)){usernameFeedback.textContent='Invalid username';usernameFeedback.style.color='red';return;}
  const taken=await db.collection('users').where('username','==',val).get();
  if(!taken.empty){usernameFeedback.textContent='Username taken';usernameFeedback.style.color='red';return;}
  const user=auth.currentUser;if(!user)return;
  await db.collection('users').doc(user.uid).set({username:val,email:user.email,online:true},{merge:true});
  usernameCard.style.display='none';homepage.style.display='block';startOnlineListener();
};

/* Show lobby */
async function showLobby(){
  const user=auth.currentUser;if(!user){showMsg('Not logged in',true);return;}
  const doc=await db.collection('users').doc(user.uid).get();
  if(!doc.exists||!doc.data().username){
    authContainer.style.display='none';usernameCard.style.display='block';homepage.style.display='none';return;
  }
  await db.collection('users').doc(user.uid).set({online:true},{merge:true});
  authContainer.style.display='none';usernameCard.style.display='none';homepage.style.display='block';startOnlineListener();
}

/* Online players */
let onlineUnsub=null;
function startOnlineListener(){
  if(onlineUnsub)onlineUnsub();
  onlineUnsub=db.collection('users').where('online','==',true).onSnapshot(snap=>{
    onlinePlayersDiv.innerHTML='';
    snap.forEach(d=>{const el=document.createElement('div');el.textContent=d.data().username||d.data().email;onlinePlayersDiv.appendChild(el);});
    if(snap.empty)onlinePlayersDiv.innerHTML='<em>No players online</em>';
  });
}

/* Game join */
playBtn.onclick=joinServerAndEnter;
async function joinServerAndEnter(){
  const user=auth.currentUser;if(!user)return alert('Log in first');
  const doc=await db.collection('users').doc(user.uid).get();
  const username=doc.data().username;
  await db.collection('serverPlayers').doc(user.uid).set({username,joinedAt:firebase.firestore.FieldValue.serverTimestamp()});
  enterGameScene();
}

/* Exit game */
exitGameBtn.onclick=async()=>{
  const user=auth.currentUser;if(user)await db.collection('serverPlayers').doc(user.uid).delete().catch(()=>{});
  cleanupGame();homepage.style.display='block';
};

/* === Three.js scene === */
let renderer,scene,camera,controls,clock,isInGame=false,animateId;
function enterGameScene(){
  authContainer.style.display='none';homepage.style.display='none';usernameCard.style.display='none';gameRoot.style.display='block';document.body.style.cursor='none';
  if(!renderer)initThree();
  isInGame=true;controls.lock();clock.start();animate();
}
function initThree(){
  renderer=new THREE.WebGLRenderer({antialias:true});renderer.setSize(window.innerWidth,window.innerHeight);gameRoot.appendChild(renderer.domElement);
  scene=new THREE.Scene();camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
  camera.position.set(0,1.7,6);
  scene.add(new THREE.HemisphereLight(0xffffff,0x444444,0.7));
  const dir=new THREE.DirectionalLight(0xffffff,0.8);dir.position.set(5,10,7);scene.add(dir);
  const metal=new THREE.MeshStandardMaterial({color:0x555A60,metalness:0.9,roughness:0.15});
  const platform=new THREE.Mesh(new THREE.BoxGeometry(10,0.6,10),metal);platform.position.y=-0.3;scene.add(platform);
  const grid=new THREE.GridHelper(10,10,0x444444,0x333333);grid.position.y=0.01;scene.add(grid);
  controls=new PointerLockControls(camera,renderer.domElement);scene.add(controls.getObject());
  clock=new THREE.Clock();const move={};const vel=new THREE.Vector3(),dirVec=new THREE.Vector3();
  window.addEventListener('keydown',e=>{if(e.code==='KeyW')move.fwd=1;if(e.code==='KeyS')move.back=1;if(e.code==='KeyA')move.left=1;if(e.code==='KeyD')move.right=1;if(e.code==='ShiftLeft')move.sprint=1;});
  window.addEventListener('keyup',e=>{if(e.code==='KeyW')move.fwd=0;if(e.code==='KeyS')move.back=0;if(e.code==='KeyA')move.left=0;if(e.code==='KeyD')move.right=0;if(e.code==='ShiftLeft')move.sprint=0;});
  animate=function(){
    animateId=requestAnimationFrame(animate);
    const delta=Math.min(0.05,clock.getDelta());
    vel.x-=vel.x*10*delta;vel.z-=vel.z*10*delta;
    dirVec.z=(move.fwd||0)-(move.back||0);dirVec.x=(move.right||0)-(move.left||0);dirVec.normalize();
    const speed=(move.sprint?8:4)*delta;if(move.fwd||move.back)vel.z-=dirVec.z*speed;if(move.left||move.right)vel.x-=dirVec.x*speed;
    controls.moveRight(-vel.x*delta);controls.moveForward(-vel.z*delta);
    renderer.render(scene,camera);
  };
}
function cleanupGame(){if(!isInGame)return;isInGame=false;if(animateId)cancelAnimationFrame(animateId);if(renderer?.domElement)renderer.domElement.remove();renderer=null;}
</script>
</body>
</html>
